<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Turni Settimanali Modificabili</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:20px; background:#f2f2f2; }
h2 { text-align:center; }
.selector { display:flex; flex-direction:column; gap:10px; margin-bottom:20px; }
select, button { padding:10px; font-size:16px; border-radius:8px; }
table { width:100%; border-collapse: collapse; background:#fff; border-radius:10px; overflow:hidden; }
th, td { padding:10px; text-align:center; border-bottom:1px solid #ddd; font-size:15px; }
th { background:#222; color:#fff; }
.blu { background:#cfe3ff; }
.giallo { background:#fff4b8; }
.verde { background:#caffc8; }
.normale { background:#ffffff; }
td[contenteditable="true"] { background: #f9f9f9; cursor:text; }
@media (max-width:600px){
  body{padding:10px;}
  th, td{padding:8px; font-size:14px;}
  select, button{font-size:14px; padding:8px;}
  table{display:block; overflow-x:auto;}
}
</style>
</head>
<body>
<h2>Turni Settimanali Modificabili</h2>

<div class="selector">
  <select id="nomeSelect">
    <option value="">Seleziona Nome</option>
    <option value="claudia">Claudia Trevisan</option>
    <option value="fabio">Papurello Fabio</option>
    <option value="chiara">Chiara Zaccurri</option>
    <option value="marco">Marco Battistioli</option>
  </select>

  <select id="settimanaSelect">
    <option value="1">Settimana 1</option>
    <option value="2">Settimana 2</option>
    <option value="3">Settimana 3</option>
    <option value="4">Settimana 4</option>
  </select>

  <button id="resetBtn">Reset ai default</button>
</div>

<table id="tabella">
  <thead>
    <tr>
      <th>Giorno</th>
      <th>Ore</th>
      <th>Dettaglio</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script type="module">
// --- FIREBASE ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCrZ940PGhcIN_c-hOXzNbHD2IN_f9mJ5k",
  authDomain: "orari-1b540.firebaseapp.com",
  projectId: "orari-1b540",
  storageBucket: "orari-1b540.firebasestorage.app",
  messagingSenderId: "211635713784",
  appId: "1:211635713784:web:41953c7af3ff9be0da6d0d"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// --- DATI DEFAULT ---
const defaultTurni = {
  claudia: {
    1:{L:{ore:"4,75", colore:"blu", det:"Mattino 07:30-12:15"}, M:{ore:"4,75", colore:"blu", det:"Mattino 07:30-12:15"}, M2:{ore:"4,75", colore:"blu", det:"Mattino 07:30-12:15"}, G:{ore:"R", colore:"verde", det:"Riposo"}, V:{ore:"4,75", colore:"blu", det:"Mattino 07:30-12:15"}, S:{ore:"4,75", colore:"blu", det:"Mattino 07:30-12:15"}, D:{ore:"4,75", colore:"blu", det:"Mattino 07:30-12:15"}},
    2:{L:{ore:"4,75", colore:"blu", det:"Mattino 07:30-12:15"}, M:{ore:"4,75", colore:"blu", det:"Mattino 07:30-12:15"}, M2:{ore:"4,75", colore:"blu", det:"Mattino 07:30-12:15"}, G:{ore:"R", colore:"verde", det:"Riposo"}, V:{ore:"4,75", colore:"blu", det:"Mattino 07:30-12:15"}, S:{ore:"4,75", colore:"blu", det:"Mattino 07:30-12:15"}, D:{ore:"4,75", colore:"blu", det:"Mattino 07:30-12:15"}},
    3:{L:{ore:"4,75", colore:"blu", det:"Mattino 07:30-12:15"}, M:{ore:"4,75", colore:"blu", det:"Mattino 07:30-12:15"}, M2:{ore:"4,75", colore:"blu", det:"Mattino 07:30-12:15"}, G:{ore:"R", colore:"verde", det:"Riposo"}, V:{ore:"4,75", colore:"blu", det:"Mattino 07:30-12:15"}, S:{ore:"4,75", colore:"blu", det:"Mattino 07:30-12:15"}, D:{ore:"4,75", colore:"blu", det:"Mattino 07:30-12:15"}},
    4:{L:{ore:"4,75", colore:"blu", det:"Mattino 07:30-12:15"}, M:{ore:"4,75", colore:"blu", det:"Mattino 07:30-12:15"}, M2:{ore:"4,75", colore:"blu", det:"Mattino 07:30-12:15"}, G:{ore:"R", colore:"verde", det:"Riposo"}, V:{ore:"4,75", colore:"blu", det:"Mattino 07:30-12:15"}, S:{ore:"4,75", colore:"blu", det:"Mattino 07:30-12:15"}, D:{ore:"4,75", colore:"blu", det:"Mattino 07:30-12:15"}}
  }
};

// --- GIORNI ---
const giorni = ["L","M","M2","G","V","S","D"];
const nomiGiorni = { L:"Lunedì", M:"Martedì", M2:"Mercoledì", G:"Giovedì", V:"Venerdì", S:"Sabato", D:"Domenica" };

// --- AGGIORNA TABELLA ---
async function aggiornaTabella(){
  const nome = document.getElementById("nomeSelect").value;
  const settimana = document.getElementById("settimanaSelect").value;
  const tbody = document.querySelector("tbody");
  tbody.innerHTML = "";
  if(!nome || !settimana) return;

  // leggi dal DB
  const docRef = doc(db, "turni", `${nome}_${settimana}`);
  const docSnap = await getDoc(docRef);
  let dati = docSnap.exists() ? docSnap.data() : defaultTurni[nome] && defaultTurni[nome][settimana] ? defaultTurni[nome][settimana] : {};

  giorni.forEach(g=>{
    const t = dati[g] || {ore:"", colore:"normale", det:""};
    const tr = document.createElement("tr");
    tr.className = t.colore;
    tr.innerHTML = `<td>${nomiGiorni[g]}</td>
      <td contenteditable="true" data-g="${g}" data-field="ore">${t.ore}</td>
      <td contenteditable="true" data-g="${g}" data-field="det">${t.det}</td>`;
    tbody.appendChild(tr);
  });
}

// --- SALVA MODIFICHE ---
document.querySelector("tbody").addEventListener("input", async e=>{
  if(e.target.dataset.g && e.target.dataset.field){
    const nome = document.getElementById("nomeSelect").value;
    const settimana = document.getElementById("settimanaSelect").value;
    const g = e.target.dataset.g;
    const field = e.target.dataset.field;

    const docRef = doc(db, "turni", `${nome}_${settimana}`);
    const docSnap = await getDoc(docRef);
    let dati = docSnap.exists() ? docSnap.data() : {};
    if(!dati[g]) dati[g] = {ore:"", colore:"normale", det:""};
    dati[g][field] = e.target.innerText;

    // set automatico del colore base (opzionale)
    dati[g].colore = (g==="G" && e.target.dataset.field==="ore" && e.target.innerText==="R") ? "verde" : "normale";

    await setDoc(docRef, dati);
    e.target.parentElement.className = dati[g].colore;
  }
});

// --- EVENTI SELECT ---
document.getElementById("nomeSelect").addEventListener("change", aggiornaTabella);
document.getElementById("settimanaSelect").addEventListener("change", aggiornaTabella);

// --- RESET ---
document.getElementById("resetBtn").addEventListener("click", async ()=>{
  if(!confirm("Sei sicuro di resettare ai valori di default?")) return;
  const nome = document.getElementById("nomeSelect").value;
  const settimana = document.getElementById("settimanaSelect").value;
  if(!nome || !settimana) return;
  const docRef = doc(db, "turni", `${nome}_${settimana}`);
  let dati = defaultTurni[nome] && defaultTurni[nome][settimana] ? defaultTurni[nome][settimana] : {};
  await setDoc(docRef, dati);
  aggiornaTabella();
});

// --- INIT ---
aggiornaTabella();

</script>
</body>
</html>

